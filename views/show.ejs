<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= issue.title %></title>
<link rel="stylesheet" href="/show.css">
  <!-- Leaflet CSS & JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
  <%- include('partials/navbar') %>

  <div class="issue-container">
    <h1><%= issue.title %></h1>

    <% if (issue.image) { %>
      <img src="<%= issue.image %>" alt="Issue Image">
    <% } %>

    <p><strong>Description:</strong> <%= issue.description %></p>
    <p><strong>üëç Upvotes:</strong> <%= issue.upvotes %></p>

    <form action="/issues/<%= issue._id %>/upvote" method="POST">
      <button type="submit">Upvote</button>
    </form>

    <div id="map"></div>

    <a href="/issues">‚Üê Back to Listings</a>
  </div>

  <script>
    // ‚úÖ Safe JSON Injection (prevents undefined errors)
    const issue =  JSON.stringify(issue) !== 'undefined' ? JSON.parse('<%- JSON.stringify(issue) %>') : null;

    const lat = issue?.location?.lat || 12.9716;  // Default: Bangalore
    const lng = issue?.location?.lng || 77.5946;

    const map = L.map('map').setView([lat, lng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Marker if location exists
    if (issue.location) {
      L.marker([lat, lng])
        .addTo(map)
        .bindPopup(`<b>${issue.title}</b><br>${issue.description}`)
        .openPopup();
    }
  </script>
</body>
</html>
